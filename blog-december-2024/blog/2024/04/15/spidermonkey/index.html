<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Servo and SpiderMonkey - Servo, the embeddable, independent, memory-safe, modular, parallel web rendering engine</title>
  <meta property="og:title" content="Servo and SpiderMonkey - Servo, the embeddable, independent, memory-safe, modular, parallel web rendering engine">
  

  
  <meta name="description" content="A new report on Servo’s integration with SpiderMonkey, and our proposal for improving its modularity.">
  <meta name="og:description" content="A new report on Servo’s integration with SpiderMonkey, and our proposal for improving its modularity.">
  
  <meta name="keywords" content="servo, servo engine, servo rendering engine, web engine, web rendering engine, web browser, web browser engine, rust">
  <meta name="author" content="The Servo Project Developers">

  <meta property="og:site_name" content="Servo">
  <meta property="og:type" content="website">
  <meta property="og:image" content="/blog-december-2024/img/servo-color-positive.png">
  <meta property="og:image:alt" content="Servo logo">
  <meta property="og:logo" content="/blog-december-2024/img/servo-symbol-color-no-container.png">
  <meta property="og:url" content="/blog-december-2024/blog/2024/04/15/spidermonkey/">

  <link rel="stylesheet" href="/blog-december-2024/css/style.css">
  <link rel="shortcut icon" href="/blog-december-2024/img/servo-symbol-color-no-container.png">
  <link href="https://unpkg.com/prismjs@1.20.0/themes/prism-okaidia.css" rel="stylesheet">
  <link rel="alternate" href="/blog-december-2024/blog/feed.xml" title="Servo Blog" type="application/atom+xml">
</head>

  <body class="is-page">
    <main class="is-main">
      <nav class="navbar" role="navigation" aria-label="main navigation">
  <div class="container">
    <div class="navbar-brand">
      <a class="navbar-item" href="/blog-december-2024/">
        <img src="/blog-december-2024/img/servo-color-negative-no-container.png" alt="Servo and SpiderMonkey">
      </a>

      <a role="button" class="navbar-burger" data-target="navbar-menu" aria-label="menu" aria-expanded="false">
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
      </a>
    </div>

    <div class="navbar-menu" id="navbar-menu">
      
        
        
          
          <div class="navbar-item has-dropdown is-hoverable">
            <a class="navbar-link
            
              
            
              
            
              
            
              
            
          " href="#">
              Get Involved
            </a>
            <div class="navbar-dropdown">
              
                <a class="navbar-item" href="/blog-december-2024/contributing/">
                  Contributing
                </a>
              
                <a class="navbar-item" href="https://book.servo.org" target="_blank">
                  Servo Book
                </a>
              
                <a class="navbar-item" href="https://wpt.servo.org/" target="_blank">
                  WPT pass rates
                </a>
              
                <a class="navbar-item" href="/blog-december-2024/coc/">
                  Code of Conduct
                </a>
              
            </div>
          </div>
        
      
        
        
          <a class="navbar-item" href="/blog-december-2024/download/">
            Download
          </a>
        
      
        
        
          <a class="navbar-item" href="/blog-december-2024/blog/">
            Blog
          </a>
        
      
        
        
          <a class="navbar-item" href="https://demo.servo.org/" target="_blank">
            Demos
          </a>
        
      
        
        
          
          <div class="navbar-item has-dropdown is-hoverable">
            <a class="navbar-link
            
              
            
              
            
              
            
              
            
          " href="#">
              About
            </a>
            <div class="navbar-dropdown">
              
                <a class="navbar-item" href="/blog-december-2024/about/">
                  About Servo
                </a>
              
                <a class="navbar-item" href="/blog-december-2024/governance/">
                  Governance
                </a>
              
                <a class="navbar-item" href="/blog-december-2024/sponsorship/">
                  Sponsorship
                </a>
              
                <a class="navbar-item" href="/blog-december-2024/acknowledgements/">
                  Acknowledgements
                </a>
              
            </div>
          </div>
        
      
      <div class="navbar-end">
  <div class="navbar-item buttons has-addons">
    
      <a class="button is-github-color" title="GitHub" href="https://github.com/servo/servo">
        <span class="icon"><i class="fab fa-github"></i></span>
      </a>
    
      <a class="button is-mastodon-color" title="Mastodon" href="https://floss.social/@servo" rel="me">
        <span class="icon"><i class="fab fa-mastodon"></i></span>
      </a>
    
      <a class="button is-bluesky-color" title="Bluesky" href="https://bsky.app/profile/servo.org">
        <span class="icon"><i class="fab fa-bluesky"></i></span>
      </a>
    
      <a class="button is-twitter-color" title="Twitter" href="https://twitter.com/ServoDev">
        <span class="icon"><i class="fab fa-twitter"></i></span>
      </a>
    
      <a class="button is-linkedin-color" title="LinkedIn" href="https://www.linkedin.com/company/servo-project/">
        <span class="icon"><i class="fab fa-linkedin"></i></span>
      </a>
    
  </div>
</div>

    </div>
  </div>
</nav>

      <section class="section" style="padding-top: 0;">
        <div class="container">
          <aside class="menu box">
            <p class="menu-label">
              Servo and SpiderMonkey
            </p>
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
          </aside>
          <div class="content">
            
<h1 class="title">Servo and SpiderMonkey</h1>
<p class="subtitle"><span class="tag is-dark">2024-04-15</span> A new report on Servo’s integration with SpiderMonkey, and our proposal for improving its modularity.</p>

<div class="has-top-margin">
  <p>As a web engine, Servo embeds another engine for its script execution capabilities, including both JavaScript and Wasm: <a href="https://spidermonkey.dev/">SpiderMonkey</a>.
One of the goals of Servo is modularity, and the question of how modular it really was with regards to those capabilities came up.
For example, how easy would it be for Servo to use Chrome’s V8 engine, or the next big script engine?
To answer that question, we’ve written a <a href="https://github.com/servo/servo/wiki/Servo-and-SpiderMonkey-Report">short report</a> analysing the relationship between Servo and SpiderMonkey.</p>
<h2 id="the-problem" tabindex="-1">The problem <a class="header-anchor" href="#the-problem">
        <span class="icon hashlink"><i class="fas fa-link"></i></span>
      </a></h2>
<p>Running a webpage happens inside the <a href="https://github.com/servo/servo/tree/main/components/script"><code>script</code></a> component of Servo; the loading process <a href="https://github.com/servo/servo/blob/d9f067e998671d16a0274c2a7c8227fec96a4607/components/script/script_thread.rs#L3192">starts there</a>, and the page continues to run its <a href="https://html.spec.whatwg.org/multipage/#event-loop-processing-model">HTML event loop</a> there.
By its very nature, executing a script from within a webpage requires an integration between the script engine and the web engine that surrounds it.
Anything shared between the two, including the DOM itself and any other construct calling from one into the other, needs to be integrated somehow, and much but not all of that is done via <a href="https://webidl.spec.whatwg.org/#introduction">WebIDL</a>.
For example, an integration area that is left for web and script engines to implement as they see fit is that with a garbage collector (see example <a href="https://github.com/servo/mozjs/blob/8603cbf35781ea8f2d57e4822a2b874f56a53914/mozjs-sys/src/jsgc.rs#L87">in Rust for SpiderMonkey</a>).</p>
<p>The need to integrate can result in tight coupling, but the classic ways of increasing <a href="https://en.wikipedia.org/wiki/Modularity">modularity</a> — abstractions and interfaces — can be applied here as well, and that is where we found Servo lacking in some ways, but also on the right path.
Servo already comes with abstractions and interfaces for <a href="https://github.com/servo/servo/tree/d9f067e998671d16a0274c2a7c8227fec96a4607/components/script/dom/bindings">a large surface area</a> of its <a href="https://github.com/servo/mozjs">integration with SpiderMonkey</a>, providing ease of use and clarity while preserving boundaries between the two.
Other parts of that integration rely on direct, and unsafe, calls into the <a href="https://github.com/servo/mozjs/tree/8603cbf35781ea8f2d57e4822a2b874f56a53914/mozjs-sys/src">low-level SpiderMonkey APIs</a>.</p>
<h2 id="the-solution" tabindex="-1">The solution <a class="header-anchor" href="#the-solution">
        <span class="icon hashlink"><i class="fas fa-link"></i></span>
      </a></h2>
<p>The low-hanging fruit consists of removing these direct calls into low-level SpiderMonkey APIs, replacing them with safe and higher-level constructs.
Work on this has started, through a combination of efforts from maintainers and the enthusiasm of community members: <a href="https://github.com/eerii">eri</a>, <a href="https://github.com/tannal">tannal</a>, and <a href="https://github.com/Taym95">Taym Haddadi</a>.
These efforts have already resulted in the closing of several issues:</p>
<ul>
<li><a href="https://github.com/servo/servo/issues/31319">WedIDL: bring dom/bindings/typedarray further in line with spec</a></li>
<li><a href="https://github.com/servo/servo/issues/31064">WebIDL: use TypedArray</a></li>
<li><a href="https://github.com/servo/servo/issues/31050">Remove create_typed_array from dom/bindings</a></li>
<li><a href="https://github.com/servo/servo/issues/31049">WebIDL: use Float32Array in GamePad</a></li>
<li><a href="https://github.com/servo/servo/issues/31048">WebIDL: use Float32Array in XRRay</a></li>
<li><a href="https://github.com/servo/servo/issues/31047">WebIDL: use Float32Array in XRRigidTransform</a></li>
<li><a href="https://github.com/servo/servo/issues/31046">WebIDL: use Float32Array in XRView</a></li>
<li><a href="https://github.com/servo/servo/issues/30890">WebIDL impl: remove unsafe JSObject from return value of Document::NamedGetter</a></li>
</ul>
<p>Note that the safer higher-level constructs that replace low-level SpiderMonkey API calls are still <a href="https://github.com/servo/servo/blob/d9f067e998671d16a0274c2a7c8227fec96a4607/components/script/dom/bindings/buffer_source.rs">internally tightly coupled</a> to SpiderMonkey.
By centralizing these calls, and hiding them from the rest of the codebase, it becomes possible to enumerate what exactly Servo is doing with SpiderMonkey, and to start thinking about a second layer of abstraction: one that would hide the underlying script engine.
An existing, and encouraging, example of such a layer comes from React Native in the form of its <a href="https://reactnative.dev/docs/the-new-architecture/landing-page#fast-javascriptnative-interfacing">JavaScript Interface (JSI)</a>.</p>
<h2 id="call-to-action" tabindex="-1">Call to action <a class="header-anchor" href="#call-to-action">
        <span class="icon hashlink"><i class="fas fa-link"></i></span>
      </a></h2>
<p>If you are interested in contributing to these efforts, the issues below are good places to start:</p>
<ul>
<li><a href="https://github.com/servo/servo/issues/30863">Modular JS/execution engine</a></li>
<li><a href="https://github.com/servo/servo/issues/30891">WebIDL impl: remove unsafe JSObject when returning a ReadableStream</a></li>
<li><a href="https://github.com/servo/servo/issues/30892">WebIDL impl: remove unsafe JSObject from WebGLExtensionWrapper</a></li>
<li><a href="https://github.com/servo/servo/issues/31072">Support FinalizationRegistry</a></li>
<li><a href="https://github.com/servo/servo/issues/30889">WebIDL impl: Replace use of NonNull<JSObject></a></li>
</ul>
<p>For more details, read <a href="https://github.com/servo/servo/wiki/Servo-and-SpiderMonkey-Report">the full report</a> on our wiki.</p>

</div>

<div class="has-top-margin buttons has-addons">
  <a class="button" href="/blog-december-2024/blog/">Back</a>
</div>

          </div>
        </div>
      </section>
    </main>
    <footer class="footer">
  <div class="container" style="text-align: center;">
    <a href="/blog-december-2024/coc/">Code of Conduct</a> |
    Contact: <a href="mailto:info@servo.org">info@servo.org</a>,
    <a href="https://servo.zulipchat.com/">Zulip Chat</a>,
    <a href="https://github.com/servo/servo/discussions">GitHub Discussions</a>,
    <a href="https://floss.social/@servo">Mastodon</a>,
    <a href="https://bsky.app/profile/servo.org">Bluesky</a>,
    <a href="https://twitter.com/ServoDev">Twitter</a>,
    <a href="https://www.linkedin.com/company/servo-project/">LinkedIn</a>
  </div>
  <div class="container" style="text-align: center; font-size: 0.875em;">
    <p><a href="https://linuxfoundation.eu"><img src="/blog-december-2024/img/lf-europe-logo.png" alt="Linux Foundation Europe logo" width="250" style="margin: 1em;"></a></p>
    <p>&copy; 2024 The Servo Project Developers</p>
    <p>Copyright &copy; Servo is a project of <a href="https://linuxfoundation.eu/">Linux Foundation Europe</a>.</p>
    <p>For website terms of use, trademark policy and other project policies please see <a href="https://lfprojects.org">https://lfprojects.org</a>.</p>
  </div>
</footer>
<script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<script>
  $(() => {
    const burger = $(".navbar-burger");
    const menu = $(".navbar-menu");
    burger.click(() => {
      [burger, menu].forEach((el) => el.toggleClass('is-active'));
    });
  });
</script>

  </body>
</html>
