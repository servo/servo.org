<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Adding support for ‘outline’ properties - Servo, the parallel browser engine</title>
  <meta property="og:title" content="Adding support for ‘outline’ properties - Servo, the parallel browser engine">
  

  <meta name="description" content="Servo is an independent, modular, embeddable web rendering engine written in Rust">
  <meta name="keywords" content="servo, servo engine, servo rendering engine, web engine, web rendering engine, web browser, web browser engine, rust">
  <meta name="author" content="The Servo Project Developers">

  <meta property="og:site_name" content="Servo">
  <meta property="og:type" content="website">
  <meta property="og:image" content="/tweaks-slides-lf-eu-member-summit/img/servo-color-positive.png">
  <meta property="og:image:alt" content="Servo logo">
  <meta property="og:logo" content="/tweaks-slides-lf-eu-member-summit/img/servo-symbol-color-no-container.png">
  <meta property="og:description" content="Servo is an independent, modular, embeddable web rendering engine written in Rust">
  <meta property="og:url" content="/tweaks-slides-lf-eu-member-summit/blog/2023/05/31/adding-support-for-outline-properties/">

  <link rel="stylesheet" href="/tweaks-slides-lf-eu-member-summit/css/style.css">
  <link rel="shortcut icon" href="/tweaks-slides-lf-eu-member-summit/img/servo-symbol-color-no-container.png">
  <link href="https://unpkg.com/prismjs@1.20.0/themes/prism-okaidia.css" rel="stylesheet">
  <link rel="alternate" href="/tweaks-slides-lf-eu-member-summit/blog/feed.xml" title="Servo Blog" type="application/atom+xml">
</head>

  <body class="is-page">
    <main class="is-main">
      <nav class="navbar" role="navigation" aria-label="main navigation">
  <div class="container">
    <div class="navbar-brand">
      <a class="navbar-item" href="/tweaks-slides-lf-eu-member-summit/">
        <img src="/tweaks-slides-lf-eu-member-summit/img/servo-color-negative-no-container.png" alt="Adding support for ‘outline’ properties">
      </a>

      <a role="button" class="navbar-burger" data-target="navbar-menu" aria-label="menu" aria-expanded="false">
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
      </a>
    </div>

    <div class="navbar-menu" id="navbar-menu">
      
        
        
          
          <div class="navbar-item has-dropdown is-hoverable">
            <a class="navbar-link
            
              
            
              
            
              
            
              
            
          " href="#">
              Get Involved
            </a>
            <div class="navbar-dropdown">
              
                <a class="navbar-item" href="/tweaks-slides-lf-eu-member-summit/contributing/">
                  Contributing
                </a>
              
                <a class="navbar-item" href="https://github.com/servo/servo/wiki" target="_blank">
                  Wiki
                </a>
              
                <a class="navbar-item" href="https://wpt.servo.org/" target="_blank">
                  WPT pass rates
                </a>
              
                <a class="navbar-item" href="/tweaks-slides-lf-eu-member-summit/coc/">
                  Code of Conduct
                </a>
              
            </div>
          </div>
        
      
        
        
          <a class="navbar-item" href="/tweaks-slides-lf-eu-member-summit/download/">
            Download
          </a>
        
      
        
        
          <a class="navbar-item" href="/tweaks-slides-lf-eu-member-summit/blog/">
            Blog
          </a>
        
      
        
        
          <a class="navbar-item" href="https://demo.servo.org/" target="_blank">
            Demos
          </a>
        
      
        
        
          
          <div class="navbar-item has-dropdown is-hoverable">
            <a class="navbar-link
            
              
            
              
            
              
            
              
            
          " href="#">
              About
            </a>
            <div class="navbar-dropdown">
              
                <a class="navbar-item" href="/tweaks-slides-lf-eu-member-summit/about/">
                  About Servo
                </a>
              
                <a class="navbar-item" href="/tweaks-slides-lf-eu-member-summit/governance/">
                  Governance
                </a>
              
                <a class="navbar-item" href="/tweaks-slides-lf-eu-member-summit/sponsorship/">
                  Sponsorship
                </a>
              
                <a class="navbar-item" href="/tweaks-slides-lf-eu-member-summit/acknowledgements/">
                  Acknowledgements
                </a>
              
            </div>
          </div>
        
      
      <div class="navbar-end">
  
    <div class="navbar-item">
      <a class="button is-github-color" href="https://github.com/servo/servo">
        <span class="icon"><i class="fab fa-github"></i></span>
        <span>GitHub</span>
      </a>
    </div>
  
    <div class="navbar-item">
      <a class="button is-mastodon-color" href="https://floss.social/@servo" rel="me">
        <span class="icon"><i class="fab fa-mastodon"></i></span>
        <span>Mastodon</span>
      </a>
    </div>
  
    <div class="navbar-item">
      <a class="button is-twitter-color" href="https://twitter.com/ServoDev">
        <span class="icon"><i class="fab fa-twitter"></i></span>
        <span>Twitter</span>
      </a>
    </div>
  
</div>

    </div>
  </div>
</nav>

      <section class="section" style="padding-top: 0;">
        <div class="container">
          <aside class="menu box">
            <p class="menu-label">
              Adding support for ‘outline’ properties
            </p>
            
              
              
            
              
              
            
              
              
            
              
              
            
              
              
            
          </aside>
          <div class="content">
            
<h1 class="title">Adding support for ‘outline’ properties</h1>
<p class="subtitle"><span class="tag is-dark">2023-05-31</span> Guide to the ‘outline’ implementation in Layout 2020, plus the tests and spec issues we added along the way.</p>

<div class="has-top-margin">
  <p>As mentioned in <a href="https://servo.org/blog/2023/04/13/layout-2013-vs-2020/">our last blog post</a>, we’re currently working on selecting a layout engine for Servo between the original Layout 2013 and the newer Layout 2020.</p>
<p>Our plan has been to start by implementing some small features in Layout 2020, to help us decide whether to switch to the new layout engine, and in turn tackle more complex features like floats. One of these features was ‘outline’, which is now supported in the new engine.</p>
<p>A few days ago, we landed support for ‘outline’ and ‘outline-offset’. These properties are now fully supported in Servo, with two minor caveats:</p>
<ul>
<li><a href="https://github.com/servo/servo/pull/29718">Snap border and outline widths at computed-value time</a> — this is blocked on a Stylo upgrade to avoid diverging from Firefox</li>
<li>The ‘outline-style’ value ‘auto’ currently works like ‘solid’ — this is allowed by the spec, but we may be able to do something better here, like rounding the corners of the outline or matching the platform style</li>
</ul>
<p>The impact of this feature is most noticeable in the focus styles for links and input fields. For example, the User Agent stylesheet already applies ‘outline: thin dotted’ to ‘a:focus’, so clicking the first link in</p>
<pre class="language-html"><code class="language-html">Lorem ipsum <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>dolor sit amet<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>,
consectetur <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>adipiscing elit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>.</code></pre>
<p>now yields</p>
<p><img src="/tweaks-slides-lf-eu-member-summit/img/blog/servo-outline.png" alt="Text with two links where the first one is focused so it has a thin outline around it"></p>
<h2 id="implementation" tabindex="-1">Implementation <a class="header-anchor" href="#implementation">
        <span class="icon hashlink"><i class="fas fa-link"></i></span>
      </a></h2>
<p>The bulk of the feature was implemented in <a href="https://github.com/servo/servo/pull/29695">#29695</a> (‘outline’) and <a href="https://github.com/servo/servo/pull/29702">#29702</a> (‘outline-offset’):</p>
<ol>
<li>In <code>{longhands,shorthands}/outline.mako.rs</code>, we enable ‘outline-offset’, ‘outline-color’, and ‘outline’ in Layout 2020, and remove the pref gates for ‘outline-style’ and ‘outline-width’, allowing those properties to be resolved and queried</li>
<li>In <code>BoxFragment::build_stacking_context_tree_for_children</code>, we check ‘outline-width’ and (if non-zero) push a <code>StackingContextFragment</code> to remind ourselves to paint an outline for the box fragment when building its display list</li>
<li>In <code>StackingContext::build_display_list</code>, we search for those reminders and paint the necessary outlines, but only after all other kinds of content in the stacking context (“out-of-band”)</li>
<li>In <code>BuilderForBoxFragment::build</code>, we now need to handle requests to paint the <code>Outline</code>, not just the <code>BlockBackgroundsAndBorders</code></li>
<li>In <code>BuilderForBoxFragment::build_outline</code>, we paint the outline by creating a <code>BorderDisplayItem</code> in WebRender, while taking the ‘outline-offset’ into account</li>
</ol>
<p>We also improved the shorthand serialisation in <a href="https://github.com/servo/servo/pull/29708">#29708</a>, by replacing the <code>#[derive(ToCss)]</code> for ‘outline’ with a custom impl that returns ‘auto’ in the case where all of the longhands are set to initial values.</p>
<h2 id="tests-and-spec-issues" tabindex="-1">Tests and spec issues <a class="header-anchor" href="#tests-and-spec-issues">
        <span class="icon hashlink"><i class="fas fa-link"></i></span>
      </a></h2>
<p>The spec allows outlines to be painted either <a href="https://drafts.csswg.org/css-position-4/#in-band-outline">in-band</a>, such that other elements can obscure them, or <a href="https://drafts.csswg.org/css-position-4/#out-of-band-outline">out-of-band</a>, on top of all other content in the stacking context. We chose the latter, because it’s the recommended approach for accessibility and matches other browsers.</p>
<p>For example, the magenta element below overlaps the blue border of the previous element, but not the out-of-band cyan outline:</p>
<pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>
    outline: 5px solid cyan;
    border: 5px solid blue;
<span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>Lorem ipsum<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>
    background: magenta;
    margin-top: -15px;
    width: 50px;
    height: 50px;
<span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></code></pre>
<p><img src="/tweaks-slides-lf-eu-member-summit/img/blog/servo-outline-painting.png" alt="Painting order is blue border, then magenta background, then “Lorem ipsum” and cyan outline"></p>
<p>‘outline’ already has good test coverage, though during our implementation we added <a href="https://github.com/servo/servo/pull/29686">one new test</a> to check that ‘background-clip’ works as expected with ‘border-radius’, which affects both borders and outlines in Servo.</p>
<p>We’ve also filed two spec issues:</p>
<ul>
<li><a href="https://github.com/w3c/csswg-drafts/issues/8786">Negative outline-offset is not interoperable and spec is not clear</a></li>
<li><a href="https://github.com/w3c/csswg-drafts/issues/8788">Should outline-offset be a longhand of outline?</a></li>
</ul>
<p>As always, despite ‘outline’ being a well-known property that has long been implemented by all of the major engines, with every new implementation comes new opportunities to clarify specs and improve test coverage. Building features like ‘outline’ helps the web platform as much as it helps Servo.</p>

</div>

<div class="has-top-margin buttons has-addons">
  <a class="button" href="/tweaks-slides-lf-eu-member-summit/blog/">Back</a>
</div>

          </div>
        </div>
      </section>
    </main>
    <footer class="footer">
  <div class="container" style="text-align: center;">
    <a href="/tweaks-slides-lf-eu-member-summit/coc/">Code of Conduct</a> |
    Contact: <a href="mailto:info@servo.org">info@servo.org</a>,
    <a href="https://servo.zulipchat.com/">Zulip Chat</a>,
    <a href="https://github.com/servo/servo/discussions">GitHub Discussions</a>,
    <a href="https://floss.social/@servo">Mastodon</a>,
    <a href="https://twitter.com/ServoDev">Twitter</a>
  </div>
  <div class="container" style="text-align: center; font-size: 0.875em;">
    <p><a href="https://linuxfoundation.eu"><img src="/tweaks-slides-lf-eu-member-summit/img/lf-europe-logo.png" alt="Linux Foundation Europe logo" width="250" style="margin: 1em;"></a></p>
    <p>&copy; 2023 The Servo Project Developers</p>
    <p>Copyright &copy; Servo is a project of <a href="https://linuxfoundation.eu/">Linux Foundation Europe</a>.</p>
    <p>For website terms of use, trademark policy and other project policies please see <a href="https://lfprojects.org">https://lfprojects.org</a>.</p>
  </div>
</footer>
<script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<script>
  $(() => {
    const burger = $(".navbar-burger");
    const menu = $(".navbar-menu");
    burger.click(() => {
      [burger, menu].forEach((el) => el.toggleClass('is-active'));
    });
  });
</script>

  </body>
</html>
